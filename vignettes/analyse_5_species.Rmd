---
title: "Use fwebinfr to infer interactions with 5 species"
author: "Kevin Cazelles"
date: 03-02-2024
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Use fwebinfr to infer interactions with 5 species}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


# System 

```{R setup, message = FALSE}
library(fwebinfr)
library(ggplot2)
library(ggraph)
library(patchwork)
library(tidygraph)
net <- fw_example_5species_2chains()
```

Interaction matrix

```{R}
net
```

Plot system

```{R plot, echo = FALSE, warning = FALSE}
tmp <- net$A
tmp[tmp<0] <- 0
grph <- tmp |> 
    as_tbl_graph() |>
    mutate(name = paste0("spc_", 1:5))  |>
    activate(edges)
p1 <- ggraph(grph, layout = "auto") +
    geom_edge_fan(show.legend = FALSE) +
    geom_node_point(colour = c(3, 2, 2, 1, 1), size = 10) + 
    theme_graph(foreground = "steelblue", fg_text_colour = "white")
print(p1)
```


# Inference

Now we call `fw_infer()` to predict interaction strengths.

```{R infer}
res <- fw_infer(net)
head(res$prediction)
```

Let's visualize the range of interaction stregth and stability.

```{R boxplot}
fw_range_plot(res)
```

Bow let's plot the dynamic for

```{R visualize, fig.height = 10}
net_most_stable <- fw_model(
  A = fw_predict_A(res, which.min(res$prediction$leading_ev)),
  B = fw_predict_B(res, which.min(res$prediction$leading_ev)),
  R = net$R
)
net_least_stable <- fw_model(
  A = fw_predict_A(res, which.max(res$prediction$leading_ev)),
  B = fw_predict_B(res, which.max(res$prediction$leading_ev)),
  R = net$R
)

p1 <- fw_ode_plot(net_most_stable, net$B/1.5, seq(0, 2, 0.0001)) +
  ggtitle("Minimum leading eigen value (most stable)") 
p2 <- fw_ode_plot(net_least_stable, net$B/1.5, seq(0, 2, 0.0001)) +
  ggtitle("Maximum leading eigen value (least stable)")
p1 / p2
```
